{% load static %}
<!DOCTYPE html>
<html lang="en">
<!-- Include Head -->
{% include 'expendable/head.html' %}

<body>
    <!-- Include Navbar -->
    {% include 'expendable/navbar.html' %}

    <!-- jQuery, Popper.js, and Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <!-- Hero Section with Parallax Effect -->
    <section class="section-hero overlay inner-page bg-image"
             style="background-image: url('{% static "images/hero_1.jpg" %}'); background-attachment: fixed;"
             id="home-section">
        <div class="container">
            <div class="row align-items-center justify-content-center text-center">
                <div class="col-md-8">
                    <h1 class="text-white display-4 font-weight-bold">Edit Product</h1>
                    <div class="custom-breadcrumbs">
                        <a href="{% url 'homepage' %}">Home</a> <span class="mx-2 slash">/</span>
                        <a href="{% url 'marketplace' %}">Products</a> <span class="mx-2 slash">/</span>
                        <span class="text-white"><strong>Edit {{ product.name }}</strong></span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Container for Form -->
    <div class="container my-5">
        <div class="row">
            <!-- Product Image Preview with Delete Button -->
            <div class="col-md-6 mb-4">
                <h4>Product Images</h4>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if product.images.all %}
                            {% for image in product.images.all %}
                                <tr id="image-row-{{ image.id }}">
                                    <td>
                                        <img src="{{ image.image.url }}" class="img-fluid" style="max-height: 150px; object-fit: cover;">
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-danger btn-sm" onclick="deleteImage('{{ image.id }}')">Delete</button>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="2">No images available.</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
                <!-- Image Upload Form -->
            </div>

            <!-- Form Section for Product Details -->
<div class="col-md-6">
    <form id="product-edit-form" method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- Image Upload -->
        <div class="form-group">
            <label for="new_images">Upload New Images</label>
            <input type="file" id="new_images" name="new_images" class="form-control" multiple>
        </div>

        <!-- Product Details -->
        <div class="form-group">
            <label for="name">Product Name</label>
            <input type="text" id="name" name="name" class="form-control" value="{{ product.name }}" required>
        </div>
        <div class="form-group">
            <label for="description">Description</label>
            <textarea id="description" name="description" class="form-control" rows="4" required>{{ product.description }}</textarea>
        </div>
        <div class="form-group">
            <label for="price">Price</label>
            <input type="number" id="price" name="price" class="form-control" value="{{ product.price }}" step="0.01" required>
        </div>
        <div class="form-group">
            <label for="category">Category</label>
            <input type="text" id="category" name="category" class="form-control" value="{{ product.category }}" required>
        </div>
        <div class="form-group">
            <label for="phone">Phone</label>
            <input type="text" id="phone" name="phone" class="form-control" value="{{ product.phone }}" required>
        </div>
        <div class="form-group">
            <label for="location">Location</label>
            <input type="text" id="location" name="location" class="form-control" value="{{ product.location }}" required>
        </div>
        <div class="form-group">
            <label for="condition">Condition</label>
            <input type="text" id="condition" name="condition" class="form-control" value="{{ product.condition }}" required>
        </div>
        <div class="form-group">
            <label for="shipping_details">Shipping Method</label>
            <input type="text" id="shipping_details" name="shipping_details" class="form-control" value="{{ product.shipping_details }}" required>
        </div>

        <!-- Submit Button -->
        <button type="submit" class="btn btn-primary btn-lg">Update Product</button>
        <a href="{% url 'marketplace_my_post' %}" class="btn btn-secondary btn-lg ml-2">Cancel</a>
    </form>
</div>
        </div>
    </div>

    <!-- Include Footer -->
    {% include 'expendable/footer.html' %}

    <script>
        function deleteImage(imageId) {
            if (confirm('Are you sure you want to delete this image?')) {
                $.ajax({
                    url: '{% url "delete_product_image" %}',
                    method: 'POST',
                    data: {
                        'image_id': imageId,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function (response) {
                        if (response.success) {
                            // Remove image row from the table
                            document.getElementById('image-row-' + imageId).remove();
                        } else {
                            alert('Error deleting image.');
                        }
                    },
                    error: function () {
                        alert('Error deleting image.');
                    }
                });
            }
        }
    </script>
</body>
</html>
